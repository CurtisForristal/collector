<!-- INCLUDE HEADER -->
<% include ../partials/header %>

<!-- If a User is signed in and viewing their collection, -->
<!-- then display the form to search for a game to add -->
<% if (currentUser && currentUser.username === user) { %>
    <h1>My Collection</h1>

    <form action="/games/results" method="GET">
        <label>Add A Game To Your Collection</label>
        <input type="text" name="search" placeholder="search">
        <button>Search</button>
    </form>
    <br>
<% } else { %>
    <!-- If User is not viewing their collection, -->
    <!-- then display the user's name for the collection they are viewing -->
    <h1><%= user %>'s Collection</h1>
<% } %>


<!-- Loop through all games and display the game info for each -->
<table class="container-fluid table table-striped table-inverse">
    <thead>
        <tr>
            <th>
                Title
                <!-- Sort Decending By Title -->
                <a class="fa fa-arrow-down" aria-hidden="true" href="/games/sort/<%= user %>/title"></a>
                <!-- Sort Accending By Title -->
                <a class="fa fa-arrow-up" aria-hidden="true" href="/games/sort/<%= user %>/titleAccending"></a>
            </th>
            <th>
                Release Year
                </a>
                <!-- Sort Decending By Release Date -->
                <a class="fa fa-arrow-down" href="/games/sort/<%= user %>/date"></a>
                <!-- Sort Accending By Release Date -->
                <a class="fa fa-arrow-up" href="/games/sort/<%= user %>/dateDecending"></a>
            </th>
            <th>
                Date Added
                </a>
                <!-- Sort Decending By Date Added -->
                <a class="fa fa-arrow-down" href="/games/sort/<%= user %>/dateAdded"></a>
                <!-- Sort Accending By Date Added -->
                <a class="fa fa-arrow-up" href="/games/sort/<%= user %>/dateAddedDecending"></a>
            </th>
            <th>
                Platforms Owned On
                </a>
                <!-- Sort Decending By Platform -->
                <a class="fa fa-arrow-down" href="/games/sort/<%= user %>/platform"></a>
                <!-- Sort Accending By Platform -->
                <a class="fa fa-arrow-up" href="/games/sort/<%= user %>/platformAccending"></a>
            
            </th>
             <!-- If displaying currentUser's collection, display Delete Game category -->
            <% if (currentUser) { %>
                <% if (games.length > 0 && games[0].author.id.equals(currentUser._id)) { %>
                    <th>Delete Game</th>
                <% } %>
            <% } %>
        </tr>
    </thead>

    <tbody>
        <% games.forEach(function(game) { %>
            <tr>
                <td><strong><%= game.title %></strong></td>
                <td><%= game.date %></td>
                <!-- Use Moment framework to display date -->
                <td><%= moment(game.dateAdded).format("MMMM Do YYYY, h:mm:ss a") %></td>
                <td>
                    <!-- Check if it's the last platform in the list -->
                    <!-- If not, add a comma after the platform -->
                    <% for (var i = 0; i < game.platforms.length; i++) { %>
                        <% if (i !== (game.platforms.length - 1)) { %>
                            <%= game.platforms[i] + "," %>
                        <% } else { %> 
                            <%= game.platforms[i] %>
                            <!-- If displaying currentUser's collection, display edit button -->
                            <% if (currentUser) { %>
                                <% if (game.author.id.equals(currentUser._id)) { %>
                                    <a class="btn btn-outline-secondary btn-sm" href="/games/<%= game._id %>/edit">Edit</a>
                                <% } %>
                            <% } %>
                        <% } %> 
                    <% }; %>
                </td>
                <td>
                    <!-- If displaying currentUser's collection, display delete button -->
                    <% if (currentUser) { %>
                        <% if (games[0].author.id.equals(currentUser._id)) { %>
                                <form id="deleteButton" action="/games/<%= game._id %>?_method=DELETE" method="POST">
                                    <button class="btn btn-outline-danger btn-sm">Delete</button>
                                </form>
                        <% } %>
                    <% } %>
                </td>
            </tr>
        <% }); %>
    </tbody>
</table>


<!-- Bootbox - Used to confirmation alert when attempting to delete a game -->
<!-- When user clicks the Delete button, the confirmation box appears -->
<script type="text/javascript">
    $("#deleteButton").on("click", function(e){
        // prevents the default form behavior
        e.preventDefault();
        bootbox.confirm("Are you sure you want to delete this game?", function(result) {
            if (result) {
                $("#deleteButton").submit();
            }
        });
    }); 
</script>



<!-- INCLUDE FOOTER -->
<% include ../partials/footer %>
